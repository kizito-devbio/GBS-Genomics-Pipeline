nextflow.enable.dsl = 2

// =======================
// Global pipeline parameters
// =======================
params {
    raw_dir      = false
    curated_dir  = false
    outdir       = "./results"
    email        = "kizitosylvester@gmail.com"

    // Automated Data Fetching Paths
    // Using projectDir ensures these are relative to the pipeline code itself
    human_ref_dir      = "${projectDir}/references/human"
    blast_db_dir       = "${projectDir}/references/streptococcus_genus_db"
    
    // FIXED: Repaired the cut-off URL for the background reference
    background_ref_url = "https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/009/585/GCF_000009585.1_ASM958v1/GCF_000009585.1_ASM958v1_genomic.fna.gz"
    
    human_accession    = "GCF_000001405.40"
    mlst_scheme        = "sagalactiae"

    // Assembly Quality / Filtering Params
    min_n50      = 10000
    min_length   = 1800000
    max_length   = 2400000
    max_contigs  = 200
    skip_tbl2asn = true

    // RESOURCE LOGIC: Portable way to handle different machines
    actual_avail_cpus = Runtime.runtime.availableProcessors()
    max_cpus   = actual_avail_cpus > 1 ? actual_avail_cpus - 1 : 1
    max_memory = "6 GB"
}

// =======================
// Profiles for environment portability
// =======================
profiles {

    docker {
        docker.enabled    = true
        // FIXED: Repaired cut-off runOptions string
        docker.runOptions = "--cpus ${params.max_cpus} --memory ${params.max_memory}"
        process.container = 'kizitodevbio/strepto-pipeline:latest'
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.cacheDir   = "${launchDir}/.singularity_cache"
        process.container      = 'docker://kizitodevbio/strepto-pipeline:latest'
    }

    conda {
        conda.enabled          = true
        conda.cacheDir         = "${projectDir}/.conda_cache"
        // FIXED: Repaired cut-off channels list
        conda.channels         = ['conda-forge', 'bioconda', 'defaults']
        conda.createOptions    = '--strict-channel-priority'
    }

    cluster {
        process.executor = 'slurm'
        process.cpus     = 16
        process.memory   = '32 GB'
        process.time     = '12.h'
    }

    test {
        params.outdir  = "./test_results"
        process.cpus   = 2
        process.memory = '4 GB'
    }
}

// =======================
// Process defaults
// =======================
process {
    errorStrategy = 'retry'
    maxRetries    = 2
    cache         = 'lenient'

    cpus      = 1
    memory    = '2 GB'
    container = 'kizitodevbio/strepto-pipeline:latest'

    withLabel: 'low_compute' {
        cpus   = 1
        memory = '2 GB'
    }

    withLabel: 'med_compute' {
        cpus   = { Math.min(2, params.max_cpus as int) }
        memory = '4 GB'
    }

    withLabel: 'high_compute' {
        cpus   = { params.max_cpus as int }
        memory = { params.max_memory }
    }
}

// =======================
// Reporting
// =======================
// Ensuring folders are created within the user-defined outdir
timeline { enabled = true; file = "${params.outdir}/logs/timeline.html" }
report   { enabled = true; file = "${params.outdir}/logs/report.html" }
trace    { enabled = true; file = "${params.outdir}/logs/trace.txt" }
dag      { enabled = true; file = "${params.outdir}/logs/dag.svg" }

// =======================
// Executor
// =======================
executor {
    name      = 'local'
    queueSize = 12
}
